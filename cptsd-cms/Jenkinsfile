pipeline {
    agent any
    
    environment {
        APP_NAME = 'cptsd-cms'
        DEPLOY_PATH = '/opt/cptsd-cms'
        DOCKER_COMPOSE_FILE = 'docker-compose.yml'
        DOCKER_COMPOSE_PROD_FILE = 'docker-compose.prod.yml'
        DOMAIN = 'cms.cptsd.in'
        
        // Environment variables from Jenkins job configuration (if set)
        // These will be used if .env files are not found
        // To set these in Jenkins:
        //   Option 1: Manage Jenkins → Configure System → Global properties → Environment variables
        //   Option 2: Job → Configure → This project is parameterized → Add String Parameters
        // These variables inherit from Jenkins global properties or job parameters
        // If not set in Jenkins, they will default to empty string and be loaded from .env files
    }
    
    stages {
        stage('Checkout') {
            steps {
                script {
                    // Clean workspace
                    sh 'rm -rf * .* || true'
                }
                checkout scm
            }
        }
        
        stage('Build') {
            steps {
                dir('cptsd-cms') {
                    script {
                        echo "Building ${APP_NAME} Docker image..."
                        sh """
                            # Load environment variables from .env or .env.local files
                            # Priority: repository .env.local > repository .env > deployment .env > Jenkins env vars
                            ENV_FILE=""
                            
                            if [ -f .env.local ]; then
                                ENV_FILE=".env.local"
                                echo "Loading environment variables from .env.local (repository)"
                            elif [ -f .env ]; then
                                ENV_FILE=".env"
                                echo "Loading environment variables from .env (repository)"
                            elif [ -f ${DEPLOY_PATH}/.env ]; then
                                ENV_FILE="${DEPLOY_PATH}/.env"
                                echo "Loading environment variables from ${DEPLOY_PATH}/.env (deployment directory)"
                            else
                                echo "No .env file found. Using Jenkins environment variables if set"
                            fi
                            
                            if [ -n "\$ENV_FILE" ]; then
                                set -a
                                . "\$ENV_FILE"
                                set +a
                            fi
                            
                            # Export environment variables for docker-compose build
                            # These will use values from .env file if loaded, otherwise from Jenkins environment variables
                            # Jenkins environment variables are set via:
                            #   - Global Properties: Manage Jenkins → Configure System → Global properties → Environment variables
                            #   - Job Parameters: Job → Configure → This project is parameterized → Add String Parameters
                            export OPENAI_API_KEY=\${OPENAI_API_KEY:-}
                            export MONGODB_URI=\${MONGODB_URI:-}
                            export S3_ENDPOINT=\${S3_ENDPOINT:-}
                            export S3_ACCESS_KEY_ID=\${S3_ACCESS_KEY_ID:-}
                            export S3_SECRET_ACCESS_KEY=\${S3_SECRET_ACCESS_KEY:-}
                            export S3_BUCKET_NAME=\${S3_BUCKET_NAME:-}
                            export ADMIN_EMAIL=\${ADMIN_EMAIL:-}
                            export ADMIN_PASSWORD=\${ADMIN_PASSWORD:-}
                            export NEXTAUTH_URL=\${NEXTAUTH_URL:-}
                            export NEXTAUTH_SECRET=\${NEXTAUTH_SECRET:-}
                            
                            # Show which variables are set (mask secrets)
                            echo "Environment variables check:"
                            echo "  OPENAI_API_KEY: \${OPENAI_API_KEY:+SET (hidden)}"
                            echo "  MONGODB_URI: \${MONGODB_URI:+SET}"
                            echo "  S3_ACCESS_KEY_ID: \${S3_ACCESS_KEY_ID:+SET (hidden)}"
                            echo "  ADMIN_EMAIL: \${ADMIN_EMAIL:+SET}"
                            echo "  NEXTAUTH_SECRET: \${NEXTAUTH_SECRET:+SET (hidden)}"
                            
                            docker-compose -f ${DOCKER_COMPOSE_FILE} build --no-cache app
                        """
                    }
                }
            }
        }
        
        stage('Test') {
            steps {
                dir('cptsd-cms') {
                    script {
                        echo 'Running tests...'
                        sh '''
                            docker-compose -f ${DOCKER_COMPOSE_FILE} run --rm app npm test || echo "Tests failed but continuing..."
                        '''
                    }
                }
            }
        }
        
        stage('Deploy') {
            steps {
                script {
                    echo "Deploying ${APP_NAME} to ${DOMAIN}..."
                    sh """
                        # Copy files to deployment directory
                        mkdir -p ${DEPLOY_PATH}
                        cp -r cptsd-cms/* ${DEPLOY_PATH}/
                        
                        # Navigate to deployment directory
                        cd ${DEPLOY_PATH}
                        
                        # Pull latest code if using git
                        if [ -d .git ]; then
                            git pull origin main || git pull origin master || true
                        fi
                        
                        # Load environment variables from .env or .env.local files
                        # Priority: deployment .env > Jenkins env vars
                        # Note: We're already in /opt/cptsd-cms directory after cd
                        ENV_FILE=""
                        
                        if [ -f .env.local ]; then
                            ENV_FILE=".env.local"
                            echo "Loading environment variables from .env.local (deployment directory)"
                        elif [ -f .env ]; then
                            ENV_FILE=".env"
                            echo "Loading environment variables from .env (deployment directory)"
                        else
                            echo "No .env file found in deployment directory. Using Jenkins environment variables if set"
                        fi
                        
                        if [ -n "\$ENV_FILE" ] && [ -f "\$ENV_FILE" ]; then
                            set -a
                            # Use full path or ./ prefix to ensure shell can find the file
                            . "./\$ENV_FILE"
                            set +a
                        fi
                        
                        # Export environment variables for docker-compose
                        # Use shell variable syntax for variables that should be evaluated in shell
                        export OPENAI_API_KEY=\${OPENAI_API_KEY:-}
                        export MONGODB_URI=\${MONGODB_URI:-}
                        export S3_ENDPOINT=\${S3_ENDPOINT:-}
                        export S3_ACCESS_KEY_ID=\${S3_ACCESS_KEY_ID:-}
                        export S3_SECRET_ACCESS_KEY=\${S3_SECRET_ACCESS_KEY:-}
                        export S3_BUCKET_NAME=\${S3_BUCKET_NAME:-}
                        export ADMIN_EMAIL=\${ADMIN_EMAIL:-}
                        export ADMIN_PASSWORD=\${ADMIN_PASSWORD:-}
                        export NEXTAUTH_URL=\${NEXTAUTH_URL:-}
                        export NEXTAUTH_SECRET=\${NEXTAUTH_SECRET:-}
                        
                        # Stop existing containers
                        docker-compose -f ${DOCKER_COMPOSE_FILE} -f ${DOCKER_COMPOSE_PROD_FILE} down || true
                        
                        # Build and start services
                        docker-compose -f ${DOCKER_COMPOSE_FILE} -f ${DOCKER_COMPOSE_PROD_FILE} build app
                        docker-compose -f ${DOCKER_COMPOSE_FILE} -f ${DOCKER_COMPOSE_PROD_FILE} up -d
                        
                        # Wait for services to be healthy
                        sleep 30
                        
                        # Check service status
                        docker-compose -f ${DOCKER_COMPOSE_FILE} -f ${DOCKER_COMPOSE_PROD_FILE} ps
                    """
                }
            }
        }
        
        stage('Health Check') {
            steps {
                script {
                    echo "Performing health check for ${DOMAIN}..."
                    sh """
                        sleep 10
                        curl -f http://localhost:3000/api/init || echo "Health check failed"
                    """
                }
            }
        }
    }
    
    post {
        success {
            echo "${APP_NAME} deployment to ${DOMAIN} successful!"
        }
        failure {
            echo "${APP_NAME} deployment to ${DOMAIN} failed!"
            sh 'docker-compose -f ${DEPLOY_PATH}/${DOCKER_COMPOSE_FILE} -f ${DEPLOY_PATH}/${DOCKER_COMPOSE_PROD_FILE} logs --tail=50'
        }
        always {
            cleanWs()
        }
    }
}
