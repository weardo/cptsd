const fs = require('fs');
const path = require('path');

// This script fixes @prisma/client to work with Next.js 16 and Turbopack
// The issue: Prisma generates TypeScript files but Node.js can't require them at runtime

const sourceDir = path.join(__dirname, '../node_modules/.prisma/client');
const prismaClientDir = path.join(__dirname, '../node_modules/@prisma/client');

if (!fs.existsSync(sourceDir)) {
  console.log('⚠️  Prisma Client not found. Skipping fix-prisma-client.');
  process.exit(0); // Exit successfully so npm install doesn't fail
}

// Create a compiled JavaScript version that Next.js/Turbopack can use
const wrapperContent = `
// This file is generated by fix-prisma-client.js
// It re-exports the Prisma Client in a way that works with Next.js 16 + Turbopack

// Read the TypeScript client and re-export it
const clientModule = require('./.prisma/client/client.ts');

// Export everything from the client
module.exports = clientModule;

// Also provide named exports for convenience
if (clientModule.PrismaClient) {
  module.exports.PrismaClient = clientModule.PrismaClient;
}
if (clientModule.Prisma) {
  module.exports.Prisma = clientModule.Prisma;
}
`;

// Update both index.js and default.js
fs.writeFileSync(path.join(prismaClientDir, 'index.js'), wrapperContent);
fs.writeFileSync(path.join(prismaClientDir, 'default.js'), wrapperContent);

// Create .prisma/client directory and symlink/copy files
const targetDir = path.join(prismaClientDir, '.prisma/client');
if (!fs.existsSync(path.dirname(targetDir))) {
  fs.mkdirSync(path.dirname(targetDir), { recursive: true });
}

if (fs.existsSync(targetDir)) {
  fs.rmSync(targetDir, { recursive: true, force: true });
}

// Copy all generated files
fs.cpSync(sourceDir, targetDir, { recursive: true });

console.log('✅ Prisma Client configured for Next.js 16 + Turbopack');
